{% extends 'memo_app/base.html' %}

{% block title %}{{ memo.title }} - メモ帳アプリ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    {% if memo.is_favorite %}⭐{% endif %}
                    {{ memo.title }}
                </h1>
                <div>
                    <button class="btn btn-outline-warning btn-sm favorite-btn me-2" data-memo-id="{{ memo.pk }}" data-is-favorite="{{ memo.is_favorite|yesno:'true,false' }}">
                        {% if memo.is_favorite %}
                            ⭐ お気に入り解除
                        {% else %}
                            ☆ お気に入り追加
                        {% endif %}
                    </button>
                    <a href="{% url 'memo_update' memo.pk %}" class="btn btn-outline-primary btn-sm">編集</a>
                    <a href="{% url 'memo_delete' memo.pk %}" class="btn btn-outline-danger btn-sm">削除</a>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {% for tag in memo.tags.all %}
                        <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                
                <div class="memo-content">
                    {{ memo.content|linebreaks }}
                </div>
                
                <hr>
                <small class="text-muted">
                    作成: {{ memo.created_at|date:"Y年m月d日 H:i" }}
                    {% if memo.updated_at != memo.created_at %}
                        | 更新: {{ memo.updated_at|date:"Y年m月d日 H:i" }}
                    {% endif %}
                </small>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="{% url 'memo_list' %}" class="btn btn-secondary">メモ一覧に戻る</a>
        </div>
    </div>
</div>

<script>
// お気に入りボタンの処理
document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.querySelector('.favorite-btn');
    
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
            const memoId = this.dataset.memoId;
            const isFavorite = this.dataset.isFavorite === 'true';
            
            fetch(`/toggle-favorite/${memoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_favorite) {
                    this.innerHTML = '⭐ お気に入り解除';
                    this.dataset.isFavorite = 'true';
                } else {
                    this.innerHTML = '☆ お気に入り追加';
                    this.dataset.isFavorite = 'false';
                }
                
                // タイトルの星も更新
                const cardTitle = document.querySelector('.card-header h1');
                if (data.is_favorite) {
                    if (!cardTitle.textContent.includes('⭐')) {
                        cardTitle.innerHTML = '⭐' + cardTitle.innerHTML;
                    }
                } else {
                    cardTitle.innerHTML = cardTitle.innerHTML.replace('⭐', '');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }
});
</script>
{% endblock %}